@page "/bp"
@inject BusinessPartnerService BusinessPartnerService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject AuthService _authService


<div class="page-header fade-in-down" style="padding-top: 16px; margin-top: 0;">
    <div class="page-header-content" style="max-width: 100%; padding: 0 16px;">
        <div class="d-flex justify-space-between align-center">
            <div class="fade-in-left delay-1" style="display: flex; align-items: center; gap: 8px;">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                               Color="Color.Surface" 
                               Size="Size.Medium"
                               Style="background: rgba(255,255,255,0.95); border-radius: 12px; color: #667eea;"
                               OnClick="@(() => Navigation.NavigateTo("/home"))" 
                               aria-label="Geri" />
                <div>
                    <MudText Typo="Typo.h5" Class="page-header-title">
                        <MudIcon Icon="@Icons.Material.Filled.People" Style="vertical-align: middle; margin-right: 8px;" />
                        Cari İşlemler
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                        Müşteri ve tedarikçi listesi
                    </MudText>
                </div>
            </div>
            <div class="fade-in-right delay-2">
                <MudIconButton Icon="@Icons.Material.Filled.FilterAlt" 
                               Color="Color.Surface" 
                               Class="hover-scale btn-press"
                               Style="background: rgba(255,255,255,0.95); border-radius: 12px; color: #667eea;"
                               @onclick="OpenFilterDialog" 
                               aria-label="Filtre" />
            </div>
        </div>
    </div>
</div>

@if (_loading)
{
    <div class="loading-container fade-in">
        <div class="loading-spinner"></div>
        <MudText Typo="Typo.body2" Class="loading-text">Veriler yükleniyor...</MudText>
    </div>
}

@if (_error)
{
    <div class="error-container fade-in-up">
        <MudIcon Icon="@Icons.Material.Filled.Error" Class="error-icon" />
        <div class="error-content">
            <div class="error-title">Hata Oluştu</div>
            <div class="error-message">@_errorMessage</div>
        </div>
    </div>
}

@if (!_loading && !_error)
{
<div class="table-container fade-in-up delay-1" style="width: 100%; overflow-x: auto; padding: 0 8px;">
<MudTable Breakpoint="Breakpoint.None"
          Items="liste" 
          Dense="true"
          Hover="true"
          SortLabel="Sort By"
          RowsPerPage="25"
          Striped="true"
          Bordered="false"
          FixedHeader="true"
          FixedFooter="true"
          RowStyleFunc="RowStyleFunc"
          Elevation="0"
          Style="height:calc(100vh - 280px);overflow-y:auto">
    <ToolBarContent>
        <div style="flex: 1;">
            <MudText Typo="Typo.h6" Style="color: #2c3e50; font-weight: 600;">
                <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Small" Style="vertical-align: middle;" />
                Firma Listesi
            </MudText>
        </div>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>İşlemler</MudTh>
        <MudTh Style="display:none;"><MudTableSortLabel SortBy="new Func<TbFirma, object>(x => x.nFirmaId)">Firma Id</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<TbFirma, object>(x => x.sKodu)">Firma Kodu</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<TbFirma, object>(x => x.sAciklama)">Firma Adı</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<TbFirma, object>(x => x.sAdres1)">Adres</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<TbFirma, object>(x => x.lBakiye)">Bakiye</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<TbFirma, object>(x => x.ToplamRisk)">Toplam Risk</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.ContentPasteSearch" @onclick="@(() => OpenBalanceDialog(context.sKodu))"></MudIconButton>
        </MudTd>
        <MudTd Style="display:none;" DataLabel="Firma Id">@context.nFirmaId</MudTd>
        <MudTd DataLabel="Kodu">@context.sKodu</MudTd>
        <MudTd DataLabel="Firma Adı">@context.sAciklama</MudTd>
        <MudTd DataLabel="Adres">@(string.IsNullOrEmpty(context.sAdres1) ? "" : context.sAdres1 + " " + (string.IsNullOrEmpty(context.sAdres2) ? "" : context.sAdres2))</MudTd>
        <MudTd DataLabel="Bakiye" Style="text-align:right">@(Convert.ToDouble(context.lBakiye).ToString("N0")) ₺</MudTd>
        <MudTd DataLabel="Toplam Risk" Style="text-align:right">@(Convert.ToDouble(context.ToplamRisk).ToString("N0")) ₺</MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager RowsPerPageString="Gösterilecek Satır" />
    </PagerContent>
</MudTable>
</div>
}

@code {
    private List<TbFirma> liste = new List<TbFirma>();
    private TbFirma filteredFirma = new TbFirma();
    private bool _loading = true;
    private bool _error = false;
    private string? _errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        TbFirma tb = new TbFirma();
        await LoadList(tb);
    }
    private string RowStyleFunc(TbFirma arg1, int index)
    {
        return (Convert.ToDouble(arg1.ToplamRisk) < 0) ? "background-color:#ff6d6d" : "";

    }
    private async Task OpenFilterDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var parameters = new DialogParameters { { "tbFirma", filteredFirma } };
        var dialog = await DialogService.ShowAsync<BusinessSmartMobile.Components.Custom_Components.BusinessPartnersFilterDialog>("Filtrele", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            filteredFirma = (TbFirma)result.Data;
            await LoadList(filteredFirma);
        }
    }

    private async Task OpenBalanceDialog(string? sKodu)
    {
        if (string.IsNullOrEmpty(sKodu))
        {
            _error = true;
            _errorMessage = "Firma kodu bulunamadı.";
            StateHasChanged();
            return;
        }

        _loading = true;
        _error = false;
        StateHasChanged();

        try
        {
            var balance = await BusinessPartnerService.Balance(sKodu);
            if (balance == null || !balance.Any())
            {
                _error = true;
                _errorMessage = "Bakiye bilgileri alınamadı.";
                return;
            }

            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraLarge };
            var parameters = new DialogParameters { { "balances", balance } };
            var dialog = await DialogService.ShowAsync<BusinessSmartMobile.Components.Custom_Components.BalanceDialog>("Cari Hareketler", parameters, options);
        }
        catch (Exception ex)
        {
            _error = true;
            _errorMessage = $"Hata oluştu: {ex.Message}";
            Snackbar.Add("Bakiye yüklenirken bir hata oluştu.", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadList(TbFirma tbFirma)
    {
        _loading = true;
        _error = false;
        StateHasChanged();

        try
        {
            var firmaList = await BusinessPartnerService.GetBpList(
    sAciklama: tbFirma.sAciklama ?? "",
    sKodu: tbFirma.sKodu ?? "",
    sAdres1: tbFirma.sAdres1 ?? "",
    sSaticiRumuzu: _authService.Auth?.sSaticiRumuzu ?? ""
);


            liste = firmaList ?? new List<TbFirma>();

            if (!liste.Any())
            {
                _error = true;
                _errorMessage = "Veri alınamadı.";
            }
        }
        catch (Exception ex)
        {
            _error = true;
            _errorMessage = $"Hata oluştu: {ex.Message}";
            Snackbar.Add("Veriler yüklenirken bir hata oluştu.", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }
}